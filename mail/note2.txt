							INIT


sudo apt update && sudo apt-get install -fy certbot ufw postfix postfix-mysql dovecot-core dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql mariadb-server mariadb-client mailutils

*internet site
*dev00ps.com

ufw allow ssh

ufw enable

certbot certonly --manual -d *.dev00ps.com -d dev00ps.com --agree-tos --manual-public-ip-logging-ok --preferred-challenges dns-01 --server https://acme-v02.api.letsencrypt.org/directory --register-unsafely-without-email --rsa-key-size 4096


							DBS


echo "Setting up dedicated database drive partition....."
echo "Please insert a drive with the desired (EMPTY) partition to use....."
lsblk | grep "disk\|part"
echo "Have you plugged in a device? If not, now is the time to do it....."
echo "Press 'c' to continue....."
while : ; do
read -n 1 k <&1
if [[ $k = c ]] ; then
	echo ""
printf "Ok then, moving on....."
break
fi
done
clear
lsblk | grep "disk\|part"
echo ""
read -p "What is the new partition to mount? (EX: sda1, sda2, sdb1 etc.....): " answ
mkfs.ext4 /dev/$answ
echo "mounting $answ"
sudo mkdir /dbs
sudo mount /dev/$answ /dbs
echo "/dev/$answ        /dbs        ext4    defaults      0      0" >> /etc/fstab
echo "Ok, /dev/$answ has been prepped with an ext4 filsystem for mounting on boot"
clear


							MYSQL appdata


sudo systemctl stop mariadb
sudo rsync -rltDvz /var/lib/mysql /dbs
sudo chown -R mysql:mysql /dbs/mysql 
mv /var/lib/mysql /var/lib/mysql.bak
sudo grep -R --color datadir /etc/mysql/*
cp /etc/mysql/mariadb.conf.d/50-server.cnf /etc/mysql/mariadb.conf.d/50-server.cnf.bak
sed -i "s+/var/lib/mysql+/dbs/mysql+gi" /etc/mysql/mariadb.conf.d/50-server.cnf
sudo grep -R --color datadir /etc/mysql/*
sudo systemctl start mariadb
clear
echo "Setting up MariaDB management..."
mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'toor';"
mysql -u root -ptoor -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost';"

							Mysql mail data

mysql -u root -ptoor -e "CREATE DATABASE mailserver;"
mysql -u root -ptoor -e "CREATE USER 'mailuser'@'127.0.0.1' IDENTIFIED BY 'toor';"
mysql -u root -ptoor -e "GRANT ALL PRIVILEGES ON mailserver.* TO 'mailuser'@'127.0.0.1';"
mysql -u root -ptoor -e "FLUSH PRIVILEGES;"



mysql -u root -ptoor

use mailserver;

CREATE TABLE `virtual_domains` (
  `id` int(11) NOT NULL auto_increment,
  `name` varchar(50) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE `virtual_users` (
  `id` int(11) NOT NULL auto_increment,
  `domain_id` int(11) NOT NULL,
  `password` varchar(106) NOT NULL,
  `email` varchar(100) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`),
  FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


mysql -u root -ptoor -e "INSERT INTO mailserver.virtual_domains (name) VALUES ('dev00ps.com');"

(should see domain)
mysql -u root -ptoor -e "SELECT * FROM mailserver.virtual_domains;"




							Email Accounts

(get output for user password hash)
sudo doveadm pw -s SHA512-CRYPT -p "toor" -r 5000

mysql -u root -ptoor -e " INSERT INTO mailserver.virtual_users (domain_id, password , email) VALUES ('1', 'newhash', 'newuser@dev00ps.com')"


(verify)
mysql -u root -ptoor -e "SELECT * FROM mailserver.virtual_users;"


(alias)
mysql -u root -ptoor -e "INSERT INTO mailserver.virtual_aliases (domain_id, source, destination) VALUES ('1', 'null@dev00ps.com', 'previoususer@dev00ps.com');"

(verify)
mysql -u root -ptoor -e "SELECT * FROM mailserver.virtual_aliases;"




							Postfix

sudo cp /etc/postfix/main.cf /etc/postfix/main.cf.orig

nano /etc/postfix/main.cf

replace
(
example.com
/etc/ssl/certs/ssl-cert-snakeoil.pem
/etc/ssl/private/ssl-cert-snakeoil.key
)
with
(
dev00ps.com
/etc/letsencrypt/live/dev00ps.com/fullchain.pem
/etc/letsencrypt/live/dev00ps.com/privkey.pem
)


nano /etc/postfix/mysql-virtual-mailbox-domains.cf

paste:

user = mailuser
password = toor
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_domains WHERE name='%s'



nano /etc/postfix/mysql-virtual-mailbox-maps.cf

paste:

user = mailuser
password = toor
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_users WHERE email='%s'



nano /etc/postfix/mysql-virtual-alias-maps.cf

paste:

user = mailuser
password = toor
hosts = 127.0.0.1
dbname = mailserver
query = SELECT destination FROM virtual_aliases WHERE source='%s'


nano /etc/postfix/mysql-virtual-email2email.cf

paste:

user = mailuser
password = toor
hosts = 127.0.0.1
dbname = mailserver
query = SELECT email FROM virtual_users WHERE email='%s'


sudo systemctl restart postfix

							
							Testing postfix

(should return 1)
sudo postmap -q dev00ps.com mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf

(should return 1)
sudo postmap -q sn@dev00ps.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf

(should return email that the alias points to)
sudo postmap -q null@dev00ps.com mysql:/etc/postfix/mysql-virtual-alias-maps.cf


							Postfix Master Program Settings

sudo cp /etc/postfix/master.cf /etc/postfix/master.cf.orig

nano /etc/postfix/master.cf 

change
(
#submission inet n       -       y       -       -       smtpd
#  -o syslog_name=postfix/submission
#  -o smtpd_tls_security_level=encrypt
#  -o smtpd_sasl_auth_enable=yes
#  -o smtpd_tls_auth_only=yes
#  -o smtpd_reject_unlisted_recipient=no
#  -o smtpd_client_restrictions=$mua_client_restrictions
#  -o smtpd_helo_restrictions=$mua_helo_restrictions
#  -o smtpd_sender_restrictions=$mua_sender_restrictions
#  -o smtpd_recipient_restrictions=
#  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
#  -o milter_macro_daemon_name=ORIGINATING
#smtps     inet  n       -       y       -       -       smtpd
#  -o syslog_name=postfix/smtps
#  -o smtpd_tls_wrappermode=yes
#  -o smtpd_sasl_auth_enable=yes
#  -o smtpd_reject_unlisted_recipient=no
#  -o smtpd_client_restrictions=$mua_client_restrictions
#  -o smtpd_helo_restrictions=$mua_helo_restrictions
#  -o smtpd_sender_restrictions=$mua_sender_restrictions
#  -o smtpd_recipient_restrictions=
#  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
#  -o milter_macro_daemon_name=ORIGINATING
)
to
(
submission inet n       -       y       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_tls_auth_only=yes
  -o smtpd_reject_unlisted_recipient=no
  -o smtpd_client_restrictions=$mua_client_restrictions
  -o smtpd_helo_restrictions=$mua_helo_restrictions
  -o smtpd_sender_restrictions=$mua_sender_restrictions
  -o smtpd_recipient_restrictions=
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
smtps     inet  n       -       y       -       -       smtpd
  -o syslog_name=postfix/smtps
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_reject_unlisted_recipient=no
  -o smtpd_client_restrictions=$mua_client_restrictions
  -o smtpd_helo_restrictions=$mua_helo_restrictions
  -o smtpd_sender_restrictions=$mua_sender_restrictions
  -o smtpd_recipient_restrictions=
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
)


sudo chmod -R o-rwx /etc/postfix

sudo systemctl restart postfix



							Dovecot


sudo cp /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf.orig
sudo cp /etc/dovecot/conf.d/10-mail.conf /etc/dovecot/conf.d/10-mail.conf.orig
sudo cp /etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d/10-auth.conf.orig
sudo cp /etc/dovecot/dovecot-sql.conf.ext /etc/dovecot/dovecot-sql.conf.ext.orig
sudo cp /etc/dovecot/conf.d/10-master.conf /etc/dovecot/conf.d/10-master.conf.orig
sudo cp /etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d/10-ssl.conf.orig



nano /etc/dovecot/dovecot.conf

line 25 add:
protocols = imap pop3 lmtp

line 26 add:
postmaster_address = postmaster at example.com


nano /etc/dovecot/conf.d/10-mail.conf


change
(
mail_location = mbox:~/mail:INBOX=/var/mail/%u
mail_privileged_group = mail
)
to
(
(make this go to the dbs drive eventually)
mail_location = maildir:/var/mail/vhosts/%d/%n/
mail_privileged_group = mail
)


sudo mkdir -p /var/mail/vhosts/dev00ps.com
sudo groupadd -g 5000 vmail
sudo useradd -g vmail -u 5000 vmail -d /var/mail
sudo chown -R vmail:vmail /var/mail


nano /etc/dovecot/conf.d/10-auth.conf

change
(
#disable_plaintext_auth = yes
auth_mechanisms = plain
#!include auth-system.conf.ext
#!include auth-sql.conf.ext
)
to
(
disable_plaintext_auth = yes
auth_mechanisms = plain login
!include auth-system.conf.ext
!include auth-sql.conf.ext
)



nano /etc/dovecot/conf.d/auth-sql.conf.ext

change 
(
line 10: driver = sql
args = /etc/dovecot/dovecot-sql.conf.ext
)
to
(
driver = static
args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n
)


nano /etc/dovecot/dovecot-sql.conf.ext

change
(
#driver =
#connect =
#default_pass_scheme = MD5
#password_query = \
)
to
(
driver = mysql
connect = host=127.0.0.1 dbname=mailserver user=mailuser password=toor
default_pass_scheme = SHA512-CRYPT
password_query = SELECT email as user, password FROM virtual_users WHERE email='%u';
)





sudo chown -R vmail:dovecot /etc/dovecot
sudo chmod -R o-rwx /etc/dovecot




nano /etc/dovecot/conf.d/10-master.conf

change
(
#port = 143
#port = 993
#ssl = yes
#port = 110
#port = 995
unix_listener lmtp
#mode = 0666

line 109: #user =

#user = $default_internal_user

line 126: #user = root

)
to
(

port = 0
port = 993
ssl = yes
port = 0
port = 995
unix_listener /var/spool/postfix/private/dovecot-lmtp
mode = 0600

line 109: user = vmail  

user = dovecot

line 126: user = vmail
)

append

line 57: 
    mode = 0600

58:
    user = postfix

59: 
    group = postfix


101:
  unix_listener /var/spool/postfix/private/auth {

102:
    mode = 0660

103:
    user = postfix

104:
    group = postfix

105:
  }





sudo systemctl restart dovecot



							
							Testing Email Server

echo "email body here" | sudo mail -s "Email subject here ig" randommailhere123@gmail.com -aFrom:sn@dev00ps.com

(check emails)
sudo mail -f /var/mail/vhosts/example.com/email1



							Email Client

			Info

Username: An email address that was configured (ex: user@example.com).
Password: The password configured for that email.
Server: (Both incoming and outgoing) A domain that resolves to the Linode (such as mail.example.com)
IMAP: Set the port to 993 and the SSL/Security settings to SSL/TLS or equivalent.
POP3: If using POP3 instead of IMAP, set the port to 995 and require SSL.
SMTP: Set the port to 587 and the SSL/Security settings to STARTTLS or equivalent.
