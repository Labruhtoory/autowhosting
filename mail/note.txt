sudo apt-get install postfix postfix-mysql dovecot-core dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql mariadb-server mariadb-client

echo "Migrating MariaDB (MySQL) data to mounted disk....."
sudo systemctl stop mariadb
sudo rsync -rltDvz /var/lib/mysql /dbs
sudo chown -R mysql:mysql /dbs/mysql 
mv /var/lib/mysql /var/lib/mysql.bak
sudo grep -R --color datadir /etc/mysql/*
cp /etc/mysql/mariadb.conf.d/50-server.cnf /etc/mysql/mariadb.conf.d/50-server.cnf.bak
sed -i "s+/var/lib/mysql+/dbs/mysql+gi" /etc/mysql/mariadb.conf.d/50-server.cnf
sudo grep -R --color datadir /etc/mysql/*
sudo systemctl start mariadb
clear
echo "Setting up MariaDB management..."
mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'toor';"
mysql -u root -ptoor -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost';"
clear


							setup Mariadb 



sudo mysqladmin -p create mailserver

sudo mysql -p mailserver

CREATE USER 'mailuser'@localhost IDENTIFIED BY 'toor';

GRANT ALL PRIVILEGES ON mailserver.* TO `mailuser`@`127.0.0.1` IDENTIFIED BY 'toor';

FLUSH PRIVILEGES;

CREATE TABLE `virtual_domains` (`id` int(11) NOT NULL auto_increment, `name` varchar(50) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `virtual_users` (`id` int(11) NOT NULL auto_increment, `domain_id` int(11) NOT NULL, `password` varchar(106) NOT NULL, `email` varchar(100) NOT NULL, PRIMARY KEY (`id`), UNIQUE KEY `email` (`email`), FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `virtual_aliases` (`id` int(11) NOT NULL auto_increment,`domain_id` int(11) NOT NULL,`source` varchar(100) NOT NULL,`destination` varchar(100) NOT NULL,PRIMARY KEY (`id`),FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8;



							Add data



INSERT INTO mailserver.virtual_domains (id ,name) VALUES ('1', 'dev00ps.com'), ('2', 'mail1.dev00ps.com'), ('3', 'mail2.dev00ps.com'), ('4', 'localhost.dev00ps.com');

INSERT INTO mailserver.virtual_users (id, domain_id, password , email) VALUES ('1', '1', ENCRYPT('toor', CONCAT('$6$', SUBSTRING(SHA(RAND()), -16))), 'sn@dev00ps.com'), ('2', '1', ENCRYPT('toor', CONCAT('$6$', SUBSTRING(SHA(RAND()), -16))), 'mn@dev00ps.com');

exit


							certbot 

apt install -fy certbot

certbot certonly --manual -d *.dev00ps.com -d dev00ps.com --agree-tos --manual-public-ip-logging-ok --preferred-challenges dns-01 --server https://acme-v02.api.letsencrypt.org/directory --register-unsafely-without-email --rsa-key-size 4096

/etc/letsencrypt/live/dev00ps.com/fullchain.pem
/etc/letsencrypt/live/dev00ps.com/privkey.pem

							Postfix

sudo cp /etc/postfix/main.cf /etc/postfix/main.cf.orig
sudo nano /etc/postfix/main.cf
sudo nano /etc/postfix/mysql-virtual-mailbox-domains.cf
sudo service postfix restart

(should return 1 if successful)
postmap -q dev00ps.com mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf

sudo nano /etc/postfix/mysql-virtual-mailbox-maps.cf

(should return 1 if successful)
postmap -q sn@dev00ps.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf



(if you have setup an alias)
sudo nano /etc/postfix/mysql-virtual-alias-maps.cf
postmap -q alias@dev00ps.com mysql:/etc/postfix/mysql-virtual-alias-maps.cf

(backup)
sudo cp /etc/postfix/master.cf /etc/postfix/master.cf.orig

(Locate and uncomment the two lines starting with submission and smtps.)
sudo nano /etc/postfix/master.cf


							Dovecot

sudo cp /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf.orig
sudo cp /etc/dovecot/conf.d/10-mail.conf /etc/dovecot/conf.d/10-mail.conf.orig
sudo cp /etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d/10-auth.conf.orig
sudo cp /etc/dovecot/dovecot-sql.conf.ext /etc/dovecot/dovecot-sql.conf.ext.orig
sudo cp /etc/dovecot/conf.d/10-master.conf /etc/dovecot/conf.d/10-master.conf.orig
sudo cp /etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d/10-ssl.conf.orig


sudo nano /etc/dovecot/dovecot.conf


echo "Setting up dedicated database drive partition....."
echo "Please insert a drive with the desired (EMPTY) partition to use....."
lsblk | grep "disk\|part"
echo "Have you plugged in a device? If not, now is the time to do it....."
echo "Press 'c' to continue....."
while : ; do
read -n 1 k <&1
if [[ $k = c ]] ; then
	echo ""
printf "Ok then, moving on....."
break
fi
done
clear
lsblk | grep "disk\|part"
echo ""
read -p "What is the new partition to mount? (EX: sda1, sda2, sdb1 etc.....): " answ
mkfs.ext4 /dev/$answ
echo "mounting $answ"
sudo mkdir /dbs
sudo mount /dev/$answ /dbs
echo "/dev/$answ        /dbs        ext4    defaults      0      0" >> /etc/fstab
echo "Ok, /dev/$answ has been prepped with an ext4 filsystem for mounting on boot"
clear

mkdir /dbs/mail/
mkdir /dbs/mail/vhosts/
(change where emails are stored)
(mail_location = maildir:/data/mail/vhosts/%d/%n)
sudo nano /etc/dovecot/conf.d/10-mail.conf

mkdir -p /data/mail/vhosts/dev00ps.com
mkdir -p /data/mail/vhosts/mail1.dev00ps.com
mkdir -p /data/mail/vhosts/mail2.dev00ps.com

chmod -R 777 /dbs/mail/

groupadd -g 5000 vmail
useradd -g vmail -u 5000 vmail -d /dbs/mail


nano /etc/dovecot/conf.d/10-auth.conf

change(
#disable_plaintext_auth = yes
auth_mechanisms = plain
!include auth-system.conf.ext
#!include auth-sql.conf.ext
)
to
(
disable_plaintext_auth = yes
auth_mechanisms = plain login
#!include auth-system.conf.ext
!include auth-sql.conf.ext
)


nano /etc/dovecot/conf.d/auth-sql.conf.ext


nano /etc/dovecot/dovecot-sql.conf.ext
change
(
#driver =
#connect =
#default_pass_scheme = MD5
#password_query = \
)
to
(
driver = mysql
connect = host=127.0.0.1 dbname=mailserver user=mailuser password=toor
default_pass_scheme = SHA512-CRYPT
password_query = SELECT email as user, password FROM virtual_users WHERE email='%u';
)



chown -R vmail:dovecot /etc/dovecot

chmod -R o-rwx /etc/dovecot

sudo nano /etc/dovecot/conf.d/10-master.conf

sudo nano /etc/dovecot/conf.d/10-ssl.conf

sudo nano /etc/dovecot/conf.d/15-lda.conf
change 
(
#postmaster_address =
)
to
(
postmaster_address = %d
)


sudo service dovecot restart

(optional)
sudo tail -f /var/log/mail.log
